default_domain_group: ghi.example.com

services:
  - name: "prod2.sub1.mod1"
    directives:
      - "ip_hash"
    locations:
      - path: "/auth/"
      - path: "/api/v2/"
        directives:
          - "set $service prod2.sub1.mod1"
          - "proxy_send_timeout 600"
        routing_rules:
          - type: percent
            arguments: ["$http_x_my_header", "20.00%"]
            dest_service: "prod2.sub1.mod1_gray"
      - path: "/api/v1/"
        directives:
          - "set $service prod2.sub1.mod1"
          - "set $my_route_var $http_app_env$cookie_app_env"
        routing_rules:
          - type: regex
            arguments: ["$my_route_var", "^gray$"]
            dest_service: "prod2.sub1.mod1_gray"
  - name: "prod2.sub2.mod2"
    directives:
      - "hash $request_uri consistent"
    locations:
      - path: "/abc2/feeds/"
        directives:
          - "set $service prod2.sub2.mod2"
          - "proxy_send_timeout 600"
        routing_rules:
          - type: percent
            arguments: ["$http_x_my_header", "20.00%"]
            dest_service: "prod2.sub2.mod2_gray"
      - re_path: "/users/\\d+/"
        directives:
          - "set $service prod2.sub2.mod2"
          - "set $my_route_var $http_app_env$cookie_app_env"
        routing_rules:
          - type: regex
            arguments: ["$my_route_var", "^gray$"]
            dest_service: "prod2.sub2.mod2_gray"
          - type: regex
            arguments: ["$http_app_env", "^gray$"]
            dest_service: "prod2.sub2.mod2_gray"
